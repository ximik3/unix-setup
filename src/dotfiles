#!/bin/bash

# Imports
source src/prettyecho

tail_after() { # tail_after '.' /etc/sys/test.sh => sh
  local SEP="$1"
  shift
  local ARGS="$@"
  local STR=$(
    IFS=$' '
    echo "${ARGS[@]}"
  )
  echo "$STR" | tr "$SEP" '\n' | tail -n 1
}

ensure_dotfiles_dir_exists() {
  if [ ! -d ~/.dotfiles ]; then
    log_info "$(bold ~/.dotfiles) directory is not found. Creating one."
    mkdir -p ~/.dotfiles
    log_info "Initializing $(bold git) in $(bold ~/.dotfiles) directory"
    git init ~/.dotfiles
  fi
}

setup_dotfile() {
  local DF_SRC="$1"
  local DF_NAME=$(basename $DF_SRC)
  local DF_DESTNAME=$([ ${DF_NAME:0:1} == '.' ] && echo ${DF_NAME:1} || echo $DF_NAME)
  local DF_DEST="$HOME/.dotfiles/$DF_DESTNAME"

  # Ensure .dotfiles folder existence
  ensure_dotfiles_dir_exists

  # Config is not found
  if [ ! -e $DF_SRC ]; then
    log_warning "$(bold $DF_SRC) config file is not found, skipping..."

  # Config file is a directory
  elif [ -d $DF_SRC ]; then
    log_warning "$(bold $DF_SRC) expected to be a file but is a directory, skipping..."

  # Config file is a link
  elif [ -L $DF_SRC ]; then
    local DF_LINK_LS_LINE=$(ls -l $DF_SRC)
    local DF_LINKED_TO=$(tail_after ' ' "$DF_LINK_LS_LINE")

    # Config link already points to the proper file
    if [ $DF_LINKED_TO == $DF_DEST ]; then
      log_info "$(bold $DF_SRC) is already linked to $(bold $DF_DEST)."
    else
      log_warning "$(bold $DF_SRC) is already linked to a file $(bold $DF_LINKED_TO) outside the ~/.dotfiles dir, skipping..."
    fi

  # Config file is an actual file
  else
    # Destination file found as well
    if [ -f $DF_DEST ]; then
      log_warning "Both source $(bold $DF_SRC) and destination $(bold $DF_DEST) files found! Will replace source file with link to destination file."
      rm $DF_SRC             # remove source file generated by installation
      ln -s $DF_DEST $DF_SRC # linking existing config from .dotfiles as source file

    # Destination is empty. Move source config to destination and create symlink
    else
      log_info "Moving $(bold $DF_SRC) to $(bold $DF_DEST) and linking."
      mv -f $DF_SRC $DF_DEST # move config to ~/.dotfiles repo
      ln -s $DF_DEST $DF_SRC # linking
    fi
  fi
}
